Haml = require('haml')
events = require('events')
mixin = require('mixin')

class FileFinder extends Backbone.View
  id: "fileFinder"

  template: Haml """
  %input.filename
  .results
  """
  matchtemplate: Haml """
  .match(data-url=fullPath)
    = projectPath
  """

  events:
    "keyup input" : "_filenameChanged"
    "click .match": "_selectFile"

  render: ->
    @$el.html(@template())
    @

  _selectFile: (e) ->
    @emit('fileSelected', $(e.target).data('url'))

  _filenameChanged: (e) ->
    searchString = $(e.target).val()
    return if searchString == ''
    matches = @model.filesMatching(searchString)

    @$el.find(".results").empty()
    for match in matches
      @$el.find(".results").append(@matchtemplate('fullPath':match.path, 'projectPath': @_projectPath(match)))

  _projectPath: (file) ->
    file.path.substr(@model.path.length)

  show: ->
    @$el.show()
    @$el.find("input.filename").focus()
    @

mixin.include(FileFinder, events.EventEmitter::)
exports.FileFinder = FileFinder