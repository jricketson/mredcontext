Haml = require('haml')

class EditorView extends Backbone.View

  className: 'editor'

  template: Haml """
    .titleBar
      .filename= model.projectPath()
    .codeEditor=model.content
    .resizer
  """

  events:
    'mousedown .resizer': '_startResizing'
    'mousedown': '_startMoving'

  initialize: ->
    @model.on('reloaded', @_setFileContent)

  _setFileContent: =>
    @codeEditor.setValue(@model.content)

  render: ->
    @$el.css(top: 100, left: 100)
    @$el.html(@template(model:@model))
    console.log("'#{@model.projectPath()}' file type: '#{@model.file_type}'")
    @codeEditor = CodeMirror(@$el.find('.codeEditor')[0], 
      mode:  @model.file_type
    )
    @

  _startResizing: (e) ->
    e.stopPropagation()
    @_startPosition=
        x:e.clientX, 
        y:e.clientY,
        width: @$el.width(), 
        height: @$el.height(), 
        edWidth:@$el.find('.codeEditor').width(), 
        edHeight:@$el.find('.codeEditor').height()

    mousemove = (e) => 
      @$el.width(@_startPosition.width+(e.clientX-@_startPosition.x))
      @$el.height(@_startPosition.height+(e.clientY-@_startPosition.y))
      @codeEditor.setSize(
          @_startPosition.edWidth+(e.clientX-@_startPosition.x),
          @_startPosition.edHeight+(e.clientY-@_startPosition.y),
      )

    mouseup = -> 
      $(document).off('mousemove', mousemove)
      $(document).off('mouseup', mouseup)

    $(document).on('mousemove', mousemove)
    $(document).on('mouseup', mouseup)

  _startMoving: (e) ->
    return unless e.target == @el or $(e.target).is(".titleBar *")
    e.stopPropagation()
    pos = @$el.position()
    @_startPosition={x:e.clientX, y:e.clientY, top: pos.top, left: pos.left}

    mousemove = (e) => 
      @$el.css(
        top: @_startPosition.top+(e.clientY-@_startPosition.y),
        left: @_startPosition.left+(e.clientX-@_startPosition.x),
      )

    mouseup = -> 
      $(document).off('mousemove', mousemove)
      $(document).off('mouseup', mouseup)

    $(document).on('mousemove', mousemove)
    $(document).on('mouseup', mouseup)

exports.EditorView = EditorView
