folder_lib = require('folder')
file_lib = require('file')

class FileList
  constructor: (@path) ->
    @files = []
    @root = new folder_lib.Folder(@path)
    @foldersLeftToRead = [@root]

  startRead: ->
    @_deferRead()
    @_readDeferred = new $.Deferred()

  _deferRead: ->
    setTimeout(@_read, 10)

  _read: =>
    folder = @foldersLeftToRead.pop()
    unless folder?
      @_readDeferred.resolve()
      return 
    folder.read().done =>
      for f in folder.files
        if f.constructor == file_lib.File
          @files.push(f)
        else if f.constructor == folder_lib.Folder
          @foldersLeftToRead.push(f)
        else
          console.error("not an instance of anything #{f} #{f.constructor} #{folder.Folder}")

      @_deferRead()

module.exports.FileList = FileList
